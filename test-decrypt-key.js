const crypto = require('crypto');

// Copy encrypted key t·ª´ database
const encryptedKey = '34de52d1530c68cea49b81337a3a7859:31d0d4c5ea6f4e5d18ac380551d4ff8210cb5fe195ea1cce431676098df96f01456747ac1ead247454e0e19673999e9a53978b9665b306a8d49bc72c94ea9c11e75510afd1531cad3cd9780ff5e5eedd268a01d822793b132b1f2bb2eded91862397a8a5dd20872038205e18b09652f3f63b94fcab9abd72f493588cf1092981ec886afa5f4b6ff0708fe091cc0a586c4b430c03845bbc24280f021428ab1d754e7d0c7b42685e5a99e8fa244276765078b235935da2d539b2b54d761a32f52e8a1b97d6786f86b13fca41fd7a4aa8e202d8dec0d2d6fd845ea946105027702a6800374587c6cb322d94b8b33a0b3a73b85f3a924c9e7ffa7e65a6eaaab223b1a964226ac403210733e3cc14c27296194ba89aeb612e4b84727d6dc635b8af585e3971aba35f24d16105d681271f289caa59569250837f749321599603b13fb6e915ce9598c8d5868752a3c3be3c4bb0ac7ebbdffa2f9f84d1dff49808ed34c9c27d12223c48b280c6117f7591de74eab1c20f20806b1327a56c09e885b5d5695ffaeaec3ed7d111e91c0bca3e846a452cc716bbad4b67bf0eb233ab1de5fe59569b5f8f70df1675036e2f1e88dc56e17adf0c8b9fe869584d6faa7e74ed224d9e7294ff351605d4f63ab173cd9d8ad99ce44562fa355f2ca1a658ab458cd5d8886c798b6c44737d70ddb0d9c9b9c74bf7504213c287d14591fce7b268feec01706a56f8e530136af652e4a97ee3b6d9c27ee93a604f7f0de2646e631d9715a32a4f887cf1b47eeb59ff475649a6b188740c5d44c087f62ed196fc564916acd40cfe78d489fe48fe37d944d1162eb40f4edf88be7662d5d632a35f3a93114e85a6fe6e6468d299548f12932e32808e57839046d56e46262d8897443c4c3f55189ec2b51d36884b2bc995af2a87e59fc61c9b0d0490763662544bdd909d255c6be732d1266b6c86866bf13fda0d0095eb0a66131d5b227c38c35c17378fc8a5e0b93b9385c5febfc1ffdac62629b21deec59c087dfe80074090cd82cab0643e0330fc675da91044ad661ef7c655cb0332d5073efb2d97ee483d23ed21b80a50dd7feeb3dad072ff81a25dad62db30782b92459e4531a66070f331470f3621f79b5e106ccff21e788f8ae51c28f60ca20ca596e11fb07dea4aa8f5665bb799a5dbeeaee8f88168eac3ab40bd55e69a0d164c47abbdcf7a4cce2231a3c4dcf945454b686d7b147e22551c94f3cff4624ee0a0aeb32559d88a2f78b20988f40c4300cecf308a19cb2c9836c234e7133d621df80fef9f27d27e5eecc7838fd5015d26568bd669b39ba57232af03ffcbd4520508c133cd0fc3c4ecfa2cf838f4b6df12bca7fc4b793e81b940150cde053131dd4f79dbcca6e251db1fe0bbd3f87e8175fc1dd59cc9927503d7e4d9abf52a340e3dca11ccd15b8627ba87835116d29bc1eb778a0344d6ea54ebca911aea9293494bb0c00b48eab34f3c42be06ad6f87fbfcab517e5231c2315c6d508689ca6b95878cd4e5514a3d2f604276b36bd156d1eb183f5a8fb6f7869ad58f9693fd9bd1f85276d29c24927883d6b8ed0a842d30f895544d2f8c75617922daca82f80e55ae62ea56404870d8b620e5d01ef56354888b87f08227b2bdf92cac5a7f6d1ce29e5f6116654130e4bdee1700ca87fe90b0a2bffc915955dbb316416570288d3ef43670f60324c96d66ec91f79489faf20b75bb8fe6c241eb97850922a6d57aa45ce6b34a5b8df93eae26215274e40f261f6fde9e44e5ef1ae7ba2451c6667473566230dd7f4492a7747d38490818e6fccebbb296698756bd7f31f2a19b6c5c549ad2dfd961ce8cd99afc9f513d536fb345e9edb645bc9c7f417242688ccd4d7c04da033f01b380c75d90b4e9031b3ea81e5fb8970f88c1dc7044c61ff4bbedc98ae6deb0bed0b9ebc98dbe616c75d29c0973fa566f62fd2e61ab1355fc21ad6a97e664243cc00315b59ff63fde9cfdecfb106a0655860aff084d5c3c392e45a998ecda1bbafe5177a60a24723259dc1c1eaeab583a63dcaa7091a22b0c7452a6c3b66ae5d0d4e510cdddb877b12813903cce64b0c1cd8e703989f5957acd18d5ac62b6f4e776430b23983985e3b86cf18957695503598d8d2719c7c91ed5fc4c76adee43d8bf8c478b95f4542007ef41a30a1c026277e876c9c63bfbaa19f2373032e38dcb9425c8bf002553067e0f709ef1282424a914c8a47ec09ff2ea25e6fe9bd52f43e80d7ce0ba8ada86a3b908567f7e8d46f50b4c0a6be6597306ce0dcdbd67858925f9b812e7ff215640a774a23a38dabd12595f87ea829691aa0dc12d08b4a05bce905c9c8bdb54d1e8e1be6ea929fac19827f798ccbdbcc612d9a7ffe65ec42bd17a6ef7ae4c9f7d67e1c5e0f8342bd27eed9c0838bfc22c372948f9fbe25eafb4d1e4f4dda75f28f4fae434b449f26c446fc6f6d679a4f0ff9c483ed03ac41a4273aa2820d6a7d20a81e1eb70a93d5d2ea89b8b0a5df30cc5d4fb8bae4442d1051ba6239252a58beef52493167d7b87d16e7982676a65955ddd4dc52862662098a79ef9687e07358ddb891301d3429a80b14c1d2fdd412d58396ea87e209ed958e597f650ec900536249726f00a4d8f7d01136fcf7b59b48caa2ceadf902eaf1d8f1c862a8ffe6fcb3abf80bf61a7b7d344c37a9aca2571c1974fc185856855da50e3d432e3c316f4acdfc94facc113588da02a8a431d20a502ba69ae66d1fb5703d06bb1b729c46e7ce9874e276e745db406feac730c3f7a7e143bc6edcf862112e32fbf61e3589ff0edb7bc03e44735660fc4eb12d5f6748c44c7ed17ed8744beb889e4fe8533bf231cf8c42047c6e0697d270c05640c37829e9161785ab3c18172a5237a2c095a1cffdd9c86ca8dd148a555faf0d0db248396afe578b6849c3bdb05cff29a4eca46ba057a3ad44311b469c6cb2633fa6176b9fb5ea6c28b7d0aae425a57d4b3506f462971b95b2ea2fcb3dbe86165bf1b6f34a51595d5db4b90e508dced8a968fa8dfd0df5265f7746e8a0abb30a8eee231d768b72479359f92cbab2fbecad3170f53a3e0ff74332c44d9385f1712f9078f92bb46803f846aa5b293d3ba0e5384ea6734a8078a9d090addc263e7a41cf632c0be9dfda6e8e1045eef63e64979a2412d6f2b34be3ca73199015f645418a44c760b7d7f9e7df051f8264bdea2f5feb7a9d805955dd7e768f77b588148e3887d30b9e9c32282cb76bc2fe38b566f26aac3b7e2d0d73628de1af515577f9c67c8c10e26627b9c0f58008d36d6cc5757e1dc859e3f0ca83a911035532dd06f8fd1338771e7d5f511f46c2e95a6285af5dc21bf62248f42ebcef8dce6e3c3864cd68c9756241291d19b75091ebbc6ccfea4c83504df7af89853ec7e9cf59a94730aa7e8f57322cb00aea1c00ab049285ff3bf4b90f4b7fb9a2b0c714d979a3414d7f67807ca12366f10a378074507f263d0a93c9b940ef9b4c015eab084e998ddbfdeee3c60355ca54b30713f917ce00b61fcda31b6f770e0b2e03cb671702e3e19b6f07a549a290756db2d2294ca2b7325e2f8ee373f93ab40a542a6622898190234ff74116f714e1b867312e7f54210fb8ca68aeac64b17b1d8b0ac8b8e5cbf29351774f6541721a77107b66f04bed7247f37f822e4a502f63be913c7b4e3103a178d51157e4526c48f4bce8927be8dd8fe0176e0440efce3b07110c240828dc4ea0d1b8c9fb2ba5702c8ac0207e6e4fa4f72b2a4ed4607b85a76513c2d4173a209ed5f56de4080cfccd6c028bf296a172a4458d7547d20f00d5d471b43ff3531a53bd6feef1dcf72bef10be7da0674d9325d40cfc65b03e26baa37793e7ab255e89fc6a716e008ecef5c2b31a36f5511c42ac226edc7cea0777144edbad72a68f6a6a91cf62153c8bdbbdca1be97286aa6e89befdbc73c2894834a6f94ef59f96978554ae35460aa495dad524b9506cb05100ec9d9b0bebe762abce9dad5ba1da2ebf30f90f7902236b512bd38e64b98b9ec2b2efc803006920d4df0eed944986fd07e68276dcfcd5fc1d71c63755eb20907bcdd5f1ef559d63ee0a19221fbafd3830d17c3dc15d694d6122185ffc425f4a64e83c07fa963b2b43e799378bd1943ea8a8bf4a43dd0e4f7db5e2425af594844c168b05b11f3f0e0b8af38f346c85664526ad6f37e28c7fdbb28106c87a5e42a702fbb647887294243cb46865b248c36ad293f06a0efa5d0f6c93ee735e2558ad3937c76b1c59dcb218f1c59fa096f8a7e35a8670b41d429ab1a3b7f60d34cc19abb9d9e580092a7e0c5a81ae8e5abd0b72ae744b169265c99c14383fa136b790d26ce13b0d1793cc060b3127b8250371f51aabdbe5ebd23d7c31f420a91db4babef372e5735edc95adafbc8a15232087196dbd5463e6bf9dec7a6fa207c1dfd799209ff097e813be5368d019d1731c1f35e7c55a92ede93bd52126fc87670cb33471c3e2d8e5429993e2a6c05b5506c4d096122e82ab765b81c55898a3634958cb34c67b4fe5fe7c0f14bcd35b1841a2b37cc75fa6cafc1a04280947fb84567b75a3300e7bb964ccd15fe54e1f910a27bbcdfc5e566cfed38770885786d7ea14f8f04f477a5c76ec15cfa7140f5f8';

// L·∫•y encryption key t·ª´ environment (ho·∫∑c hardcode ƒë·ªÉ test)
const encryptionKey = process.env.SSH_KEY_ENCRYPTION_SECRET || 'your-secure-encryption-secret-key-min-32-chars-long';

function decryptPrivateKey(encryptedKey) {
  // Convert hex string to Buffer
  let keyBuffer;
  try {
    keyBuffer = Buffer.from(encryptionKey, 'hex');
  } catch (error) {
    // If not hex, use the raw string as UTF-8 and hash it to 32 bytes
    keyBuffer = crypto.createHash('sha256').update(encryptionKey).digest();
  }

  // Ensure key is exactly 32 bytes for aes-256-cbc
  if (keyBuffer.length !== 32) {
    keyBuffer = crypto.createHash('sha256').update(encryptionKey).digest();
  }

  const parts = encryptedKey.split(':');
  if (parts.length !== 2) {
    throw new Error('Invalid encrypted key format');
  }

  const iv = Buffer.from(parts[0], 'hex');
  const encrypted = parts[1];
  
  const decipher = crypto.createDecipheriv(
    'aes-256-cbc',
    keyBuffer,
    iv
  );
  
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}

console.log('üîê Testing SSH Key Decryption\n');
console.log('Encryption Key:', encryptionKey.substring(0, 20) + '...');
console.log('\n');

try {
  const decrypted = decryptPrivateKey(encryptedKey);
  
  console.log('‚úÖ Decryption successful!');
  console.log('Decrypted length:', decrypted.length);
  console.log('\nüìù First 100 characters:');
  console.log(decrypted.substring(0, 100));
  console.log('\nüìù Last 100 characters:');
  console.log(decrypted.substring(decrypted.length - 100));
  console.log('\n');
  
  // Check format
  if (decrypted.includes('BEGIN') && decrypted.includes('PRIVATE KEY')) {
    console.log('‚úÖ Decrypted key appears to be in PEM format');
    
    if (decrypted.includes('BEGIN RSA PRIVATE KEY')) {
      console.log('   Format: PKCS#1 RSA Private Key');
    } else if (decrypted.includes('BEGIN PRIVATE KEY')) {
      console.log('   Format: PKCS#8 Private Key');
    } else if (decrypted.includes('BEGIN OPENSSH PRIVATE KEY')) {
      console.log('   Format: OpenSSH Private Key');
    }
  } else {
    console.log('‚ùå Decrypted key does NOT appear to be valid PEM format');
    console.log('   This will cause "Unsupported key format" error in ssh2');
  }
  
  // Full output
  console.log('\nüìÑ Full decrypted key:\n');
  console.log(decrypted);
  
} catch (error) {
  console.log('‚ùå Decryption failed:', error.message);
  console.log('\nPossible causes:');
  console.log('1. SSH_KEY_ENCRYPTION_SECRET environment variable not set or incorrect');
  console.log('2. Key was encrypted with different secret');
  console.log('3. Encrypted data is corrupted');
}
